#!/bin/bash

COMPOSE_PROJECT=devops-challenge
COMPOSE_FILES=("docker-compose.shell.yml")

export COMPOSE_PROJECT_NAME="${COMPOSE_PROJECT}"

FILE_ARGS=()
for FILE in "${COMPOSE_FILES[@]}"; do
  FILE_ARGS+=(-f "${FILE}")
done

if [ $# -eq 0 ]; then
  echo "Usage: ./shell <command>"
  echo ""
  echo "Run any command inside the dockershell environment:"
  echo "  ./shell terraform plan"
  echo "  ./shell kubectl get nodes"
  echo ""
  echo "To rebuild the image with --no-cache:"
  echo "  ./shell --build"
  exit 1
fi

if [ "$1" == "--build" ]; then
  docker compose "${FILE_ARGS[@]}" build --no-cache
  exit $?
fi

docker compose "${FILE_ARGS[@]}" run \
  --rm \
  --pull never \
  -u 1000 \
  --service-ports \
  app \
  bash -c "$*"
